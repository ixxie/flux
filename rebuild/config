#!/usr/bin/env bash
set -e
fluxlib bash

. "$FLUX_HOME/env/user"
. "$FLUX_HOME/env/host"

function maketemp
{
    template="$1"
    file="$2"

    cp "$template" "$file"

    com="sed -i"


    for var in username fullname hostname timezone
    do
        #sleep 1
        clnvar=${!var//\//\\\/}
        com="$com -e 's;\$$var;$clnvar;g'"
    done

    eval "$com $file"
}

templates=$(find "$FLUX_HOME/env/nixos/" -name "*.tmp")

for file in $templates
    do
        maketemp "${file:0:-4}".{tmp,nix}
done

